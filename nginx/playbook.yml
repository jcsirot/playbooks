---

- name: install nginx
  hosts: debian:ubuntu:&nginx
  vars_files:
  - defaults.yml
  handlers:
  - name: reload nginx
    service:
      name: nginx
      state: reloaded
  tasks:
  - apt:
      name: nginx
      state: present
  - synchronize:
      src: "{{ nginx_sites_path|default(nginx_sites_path_default) }}/"
      dest: /etc/nginx/sites-enabled/
    notify:
    - reload nginx
  - copy:
      src: "{{ nginx_crt_path|default(nginx_crt_path_default) }}/"
      dest: /etc/nginx/crt
  - service:
      name: nginx
      state: started
      enabled: yes

- name: uninstall nginx
  hosts: debian:ubuntu:&no-nginx
  tasks:
  - service:
      name: nginx
      state: stopped
      enabled: no
    ignore_errors: yes
  - apt:
      name: nginx
      state: absent
      purge: yes

- name: install nginx ferm mod
  hosts: debian:&ferm:&nginx
  vars_files:
  - defaults.yml
  handlers:
  - name: reload ferm
    service:
      name: ferm
      state: reloaded
  tasks:
  - template:
      src: ferm.j2
      dest: /etc/ferm.d/nginx
    notify:
    - reload ferm

- name: uninstall nginx ferm mod
  hosts: debian:&ferm:&no-nginx
  handlers:
  - name: reload ferm
    service:
      name: ferm
      state: reloaded
  tasks:
  - file:
      path: /etc/ferm.d/nginx
      state: absent
    notify:
    - reload ferm
