---

- name: install docker
  hosts: debian:&docker
  vars_files:
  - defaults.yml
  handlers:
  - name: reload docker
    service:
      name: docker
      state: reloaded
  tasks:
#  - apt_repository:
#      repo: "deb http://http.debian.net/debian wheezy-backports main"
#      state: present
#      update_cache: yes
#  - apt:
#      name: linux-image-amd64
#      state: present
  - get_url:
      url: https://get.docker.com/
      dest: /var/tmp/install_docker.sh
      mode: "700"
    environment:
      https_proxy: "{{ docker_https_proxy|default(docker_https_proxy_default) }}"
  - command: /var/tmp/install_docker.sh
    args:
      creates: /usr/bin/docker
  - template:
      src: settings.j2
      dest: /etc/default/docker
    notify:
    - reload docker
  - service:
      name: docker
      state: started
      enabled: yes

#- name: uninstall docker
#  hosts: debian:&docker
#  tasks:
#  - name: docker is stopped
#    service:
#      name: docker
#      state: stopped
#      enabled: no
#    ignore_errors: yes
#  - file:
#      path: {{ item }}
#      state: absent
#    with_items:
#    - /etc/default/docker
#    - /var/tmp/install_docker.sh
#  - to be continuedâ€¦

- name: manage docker ferm mod
  hosts: debian:&ferm:&docker
  vars_files:
  - defaults.yml
  handlers:
  - name: reload ferm
    service:
      name: ferm
      state: reloaded
  tasks:
  - name: add docker ferm mod if non-local
    template:
      src: ferm.j2
      dest: /etc/ferm.d/docker
    when: "'{{ docker_listen_address|default(docker_listen_address_default) }}' !=  '127.0.0.1'"
    notify:
    - reload ferm
  - name: remove docker ferm mod if local
    file:
      path: /etc/ferm.d/docker
      state: absent
    when: "'{{ docker_listen_address|default(docker_listen_address_default) }}' ==  '127.0.0.1'"
    notify:
    - reload ferm

- name: uninstall docker ferm mod
  hosts: debian:&ferm:&no-docker
  vars_files:
  - defaults.yml
  handlers:
  - name: reload ferm
    service:
      name: ferm
      state: reloaded
  tasks:
  - name: remove docker ferm mod
    file:
      path: /etc/ferm.d/docker
      state: absent
    notify:
    - reload ferm
